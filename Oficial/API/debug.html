<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Debug API - Pesquisar Usu√°rio</title>
    <!-- P√°gina de debug - n√£o usa geral.js para evitar verifica√ß√µes de cookie -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: rgb(11, 16, 20);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            color: #EB1C8F;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .search-section {
            background: rgba(43, 48, 54, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(235, 28, 143, 0.3);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #EB1C8F;
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #DFB313;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #EB1C8F, #DFB313);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .search-btn:hover {
            transform: scale(1.05);
        }
        
        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .status.loading {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #93c5fd;
            display: block;
        }
        
        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #86efac;
            display: block;
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            display: block;
        }
        
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }
        
        @media (max-width: 1200px) {
            .results {
                grid-template-columns: 1fr;
            }
        }
        
        .results > .section:first-child {
            grid-column: 1 / -1;
        }
        
        .section {
            background: rgba(43, 48, 54, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            color: #DFB313;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title .badge {
            background: #EB1C8F;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .user-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #EB1C8F;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }
        
        .user-username {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .stat {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .stat-value {
            color: #DFB313;
            font-weight: 600;
        }
        
        .stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .story-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .story-item:hover {
            transform: scale(1.05);
        }
        
        .story-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .story-info {
            padding: 10px;
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .following-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .following-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .following-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .following-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .json-viewer {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .json-viewer::-webkit-scrollbar {
            width: 8px;
        }
        
        .json-viewer::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .json-viewer::-webkit-scrollbar-thumb {
            background: #EB1C8F;
            border-radius: 4px;
        }
        
        .localstorage-section {
            margin-top: 20px;
        }
        
        .localstorage-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #517aff;
        }
        
        .localstorage-key {
            color: #DFB313;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .localstorage-value {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .toggle-btn {
            background: #517aff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .toggle-btn:hover {
            background: #3b5bdb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #EB1C8F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug API - Pesquisar Usu√°rio</h1>
        
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="usernameInput" 
                    class="search-input" 
                    placeholder="@username ou username"
                    autocomplete="off"
                >
                <button id="searchBtn" class="search-btn" onclick="searchUser()">Buscar</button>
            </div>
            <div id="status" class="status"></div>
        </div>
        
        <div id="results" class="results" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        üë§ Dados do Usu√°rio (API)
                        <span class="badge" id="userBadge">-</span>
                    </h2>
                    <div id="userData"></div>
                    <div class="json-viewer" id="userJson"></div>
                </div>
                
            <div class="section" id="followersSection">
                    <h2 class="section-title">
                        üë• Seguidores (API)
                        <span class="badge" id="followersBadge">-</span>
                    </h2>
                    <div id="followersData"></div>
                    <div class="json-viewer" id="followersJson"></div>
                </div>
                
            <div class="section" id="followingSection">
                    <h2 class="section-title">
                        üë• Seguindo (API)
                        <span class="badge" id="followingBadge">-</span>
                    </h2>
                    <div id="followingData"></div>
                    <div class="json-viewer" id="followingJson"></div>
                </div>
                
                <div class="section" id="chainingSection" style="display: none;">
                    <h2 class="section-title">
                        üîó Chaining Results (Perfis Sugeridos)
                        <span class="badge" id="chainingBadge">-</span>
                    </h2>
                    <div id="chainingInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(59, 130, 246, 0.2); border-radius: 6px; color: #93c5fd;">
                        <strong>‚ÑπÔ∏è Perfis Sugeridos:</strong> Estes s√£o perfis relacionados que podem ser usados para criar stories e posts quando following/followers estiverem insuficientes.
                    </div>
                    <div id="chainingData"></div>
                    <div class="json-viewer" id="chainingJson"></div>
                </div>
                
                <div class="section" id="lastPostsSection" style="display: block;">
                    <h2 class="section-title">
                        üì∏ √öltimos Posts
                        <span class="badge" id="lastPostsBadge">-</span>
                    </h2>
                    <div id="lastPostsInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(223, 179, 19, 0.2); border-radius: 6px; color: #fde047;">
                        <strong>‚ÑπÔ∏è √öltimos Posts:</strong> Esta se√ß√£o exibe os √∫ltimos posts do perfil.
                    </div>
                    <div id="lastPostsData"><div class="empty-state">Nenhum post dispon√≠vel</div></div>
                    <div class="json-viewer" id="lastPostsJson"></div>
            </div>
            
                <div class="section" id="mutualSection" style="display: block;">
                    <h2 class="section-title">
                        üë• Perfis M√∫tuos
                        <span class="badge" id="mutualBadge">-</span>
                    </h2>
                    <div id="mutualInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(34, 197, 94, 0.2); border-radius: 6px; color: #86efac;">
                        <strong>‚ÑπÔ∏è Perfis M√∫tuos:</strong> Perfis que o usu√°rio espionado segue E que seguem de volta (mutual followers). Inclui p√∫blicos e privados.
                </div>
                    <div id="mutualData"><div class="empty-state">Carregando perfis m√∫tuos...</div></div>
                    <div class="json-viewer" id="mutualJson"></div>
            </div>
            </div>
            
        </div>
    </div>
    
    <!-- Modal para imagens -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <button class="close-modal" onclick="closeImageModal()">‚úï Fechar</button>
        <img id="modalImage" src="" alt="Imagem">
    </div>
    
    <script>
        // P√ÅGINA DE DEBUG - SEM VERIFICA√á√ïES DE COOKIE OU LIMPEZAS
        // Esta √© uma p√°gina de teste interno, funciona independentemente
        
        console.log('üîß P√°gina de Debug - Modo de teste interno ativado');
        
        // Fun√ß√£o getApiUrl - vers√£o standalone para debug (n√£o depende de geral.js)
        function getApiUrl(endpoint) {
            // Sempre usar porta 8002 para a API
            const apiPort = 8002;
            const baseUrl = `http://localhost:${apiPort}`;
            // Remover barra inicial se endpoint j√° tiver
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint : '/' + endpoint;
            return `${baseUrl}${cleanEndpoint}`;
        }
        
        // Fun√ß√£o getProxyImageUrl usa getProxyUrl de geral.js
        function getProxyImageUrl(imageUrl) {
            if (typeof getProxyUrl === 'function') {
                return getProxyUrl(imageUrl);
            }
            // Fallback se geral.js n√£o estiver carregado
            if (!imageUrl) return '';
            if (imageUrl.includes('/proxy-image')) return imageUrl;
            const apiPort = 8002;
            return `http://localhost:${apiPort}/proxy-image?url=${encodeURIComponent(imageUrl)}`;
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function showImageModal(src) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = src;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function renderUserData(user, usernameParam = null) {
            const container = document.getElementById('userData');
            if (!user || !user.user) {
                container.innerHTML = '<div class="empty-state">Nenhum dado do usu√°rio encontrado</div>';
                return;
            }
            
            const u = user.user;
            const avatarUrl = u.profile_pic_url || u.profile_pic_url_hd || '';
            const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
            const isPrivate = u.is_private === true || u.is_private === 'true' || u.is_private === 1;
            
            const allUserFields = Object.keys(u);
            
            container.innerHTML = `
                <div class="user-card">
                    ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${u.username}" class="user-avatar" onclick="showImageModal('${proxyAvatarUrl}')" style="cursor: pointer;" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(){showImageModal('${avatarUrl}')};">` : '<div class="user-avatar" style="background: #EB1C8F;"></div>'}
                    <div class="user-info">
                        <div class="user-name">${u.full_name || 'Sem nome'} ${isPrivate ? '<span style="color: #ef4444; font-size: 12px;">üîí PRIVADO</span>' : '<span style="color: #22c55e; font-size: 12px;">üåê P√öBLICO</span>'}</div>
                        <div class="user-username">@${u.username || 'N/A'}</div>
                        <div class="user-stats">
                            <div class="stat">
                                <span class="stat-value">${formatNumber(u.follower_count || 0)}</span> seguidores
                            </div>
                            <div class="stat">
                                <span class="stat-value">${formatNumber(u.following_count || 0)}</span> seguindo
                            </div>
                            <div class="stat">
                                <span class="stat-value">${formatNumber(u.media_count || 0)}</span> posts
                            </div>
                        </div>
                        ${u.biography ? `<div style="margin-top: 10px; color: rgba(255,255,255,0.7); font-size: 14px;">${u.biography}</div>` : ''}
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border: 1px solid #3b82f6;">
                    <strong style="color: #93c5fd;">üìä Pr√©via dos Campos (${allUserFields.length} campos total):</strong>
                    <div style="margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.8);">
                        <code style="word-break: break-all; line-height: 1.6;">${allUserFields.slice(0, 30).join(', ')}${allUserFields.length > 30 ? ` ... e mais ${allUserFields.length - 30} campos` : ''}</code>
                    </div>
                    <button onclick="document.getElementById('userJson').style.display = document.getElementById('userJson').style.display === 'none' ? 'block' : 'none'; this.textContent = document.getElementById('userJson').style.display === 'none' ? 'Mostrar JSON Completo' : 'Ocultar JSON';" style="margin-top: 10px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Mostrar JSON Completo</button>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <strong style="color: #DFB313;">Informa√ß√µes Espec√≠ficas:</strong><br>
                        ${u.is_verified ? '‚úÖ Conta verificada<br>' : ''}
                        ${u.is_business_account || u.is_business ? '‚úÖ Conta comercial<br>' : ''}
                    </div>
                </div>
            `;
            
            // Ocultar JSON por padr√£o
            document.getElementById('userJson').style.display = 'none';
            document.getElementById('userJson').textContent = JSON.stringify(user, null, 2);
            document.getElementById('userBadge').textContent = '‚úì';
            
            // Se tiver chaining_results, mostrar se√ß√£o (para perfis p√∫blicos E privados)
            const currentUsername = u.username || usernameParam || '';
            console.log('üîç Verificando chaining_results para:', currentUsername, 'pk:', u.pk);
            console.log('üìã has_chaining:', u.has_chaining);
            console.log('üìã chaining_results existe?', 'chaining_results' in u);
            console.log('üìã Tipo de chaining_results:', typeof u.chaining_results);
            console.log('üìã √â array?', Array.isArray(u.chaining_results));
            if (u.chaining_results) {
                console.log('üìã Tamanho:', u.chaining_results.length);
            }
            
            // Mostrar perfis sugeridos APENAS para perfis PRIVADOS (isPrivate j√° foi declarado acima)
            if (isPrivate && u.chaining_results && Array.isArray(u.chaining_results) && u.chaining_results.length > 0) {
                // Mostrar perfis sugeridos apenas para perfis privados
                document.getElementById('chainingSection').style.display = 'block';
                renderChainingResults(u.chaining_results, currentUsername);
                console.log('‚úÖ Perfil PRIVADO - Exibindo perfis sugeridos:', u.chaining_results.length, 'perfis');
            } else if (!isPrivate) {
                // Perfil p√∫blico: n√£o mostrar perfis sugeridos
                console.log('üåê Perfil P√öBLICO - N√£o exibir perfis sugeridos');
                document.getElementById('chainingSection').style.display = 'none';
            } else {
                // Perfil privado sem chaining_results
                console.warn('‚ö†Ô∏è Perfil privado mas sem chaining_results');
                document.getElementById('chainingSection').style.display = 'none';
            }
        }
        
        function renderFollowersData(followers) {
            const container = document.getElementById('followersData');
            const jsonContainer = document.getElementById('followersJson');
            
            let followersArray = [];
            if (followers && followers.followers && Array.isArray(followers.followers)) {
                followersArray = followers.followers;
            } else if (followers && followers.users && Array.isArray(followers.users)) {
                followersArray = followers.users;
            } else if (Array.isArray(followers)) {
                followersArray = followers;
            }
            
            if (followersArray.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum seguidor encontrado</div>';
                jsonContainer.textContent = JSON.stringify(followers, null, 2);
                document.getElementById('followersBadge').textContent = '0';
                return;
            }
            
            // Analisar campos dispon√≠veis no primeiro follower
            const firstFollower = followersArray[0];
            const availableFields = firstFollower ? Object.keys(firstFollower) : [];
            const hasIsPrivate = availableFields.includes('is_private');
            
            // Mostrar informa√ß√µes sobre campos dispon√≠veis (simplificado)
            let fieldsInfo = '';
            if (hasIsPrivate) {
                fieldsInfo = `
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border: 1px solid #3b82f6;">
                        <strong style="color: #93c5fd;">üìä Campos Dispon√≠veis:</strong>
                        <div style="margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                            ${hasIsPrivate ? '‚úÖ is_private<br>' : '‚ùå is_private<br>'}
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <strong>Pr√©via dos campos (${availableFields.length} total):</strong><br>
                                <code style="font-size: 10px; color: #DFB313;">${availableFields.slice(0, 20).join(', ')}${availableFields.length > 20 ? '...' : ''}</code>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = fieldsInfo + `
                <div class="following-list">
                    ${followersArray.slice(0, 50).map(user => {
                        const avatarUrl = user.profile_pic_url || user.profile_pic_url_hd || '';
                        const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
                        const username = user.username || 'N/A';
                        const fullName = user.full_name || '';
                        const isPrivate = user.is_private === true || user.is_private === 'true' || user.is_private === 1;
                        
                        return `
                            <div class="following-item" style="position: relative; padding: 12px;">
                                ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${username}" class="following-avatar" onclick="showImageModal('${proxyAvatarUrl}')" style="cursor: pointer;" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(){showImageModal('${avatarUrl}')};">` : '<div class="following-avatar" style="background: #517aff;"></div>'}
                                <div style="flex: 1;">
                                    <div class="following-name">
                                        ${fullName || username}
                                        ${isPrivate ? '<span style="color: #ef4444; font-size: 10px; margin-left: 5px;">üîí PRIVADO</span>' : '<span style="color: #22c55e; font-size: 10px; margin-left: 5px;">üåê P√öBLICO</span>'}
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">@${username}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${followersArray.length > 50 ? `<div style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.6);">... e mais ${followersArray.length - 50} seguidores</div>` : ''}
            `;
            
            jsonContainer.textContent = JSON.stringify(followers, null, 2);
            document.getElementById('followersBadge').textContent = followersArray.length;
        }
        
        function renderFollowingData(following) {
            const container = document.getElementById('followingData');
            const jsonContainer = document.getElementById('followingJson');
            
            console.log('üé® Renderizando following data:', following);
            
            // Se following √© null ou undefined, mostrar mensagem
            if (!following) {
                container.innerHTML = '<div class="empty-state" style="color: #ef4444;">‚ö†Ô∏è Dados de following n√£o foram recebidos da API</div>';
                jsonContainer.textContent = 'null ou undefined';
                document.getElementById('followingBadge').textContent = '0';
                return;
            }
            
            let followingArray = [];
            if (following && following.following && Array.isArray(following.following)) {
                followingArray = following.following;
                console.log('‚úÖ Encontrado following.following:', followingArray.length);
            } else if (following && following.users && Array.isArray(following.users)) {
                followingArray = following.users;
                console.log('‚úÖ Encontrado following.users:', followingArray.length);
            } else if (Array.isArray(following)) {
                followingArray = following;
                console.log('‚úÖ Following √© array direto:', followingArray.length);
            } else {
                console.warn('‚ö†Ô∏è Formato desconhecido de following:', following);
            }
            
            if (followingArray.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum following encontrado</div>';
                jsonContainer.textContent = JSON.stringify(following, null, 2);
                document.getElementById('followingBadge').textContent = '0';
                return;
            }
            
            // Analisar campos dispon√≠veis no primeiro following
            const firstFollowing = followingArray[0];
            const availableFields = firstFollowing ? Object.keys(firstFollowing) : [];
            const hasIsPrivate = availableFields.includes('is_private');
            
            // Mostrar informa√ß√µes sobre campos dispon√≠veis (simplificado)
            let fieldsInfo = '';
            if (hasIsPrivate) {
                fieldsInfo = `
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border: 1px solid #3b82f6;">
                        <strong style="color: #93c5fd;">üìä Campos Dispon√≠veis:</strong>
                        <div style="margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                            ${hasIsPrivate ? '‚úÖ is_private<br>' : '‚ùå is_private<br>'}
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <strong>Pr√©via dos campos (${availableFields.length} total):</strong><br>
                                <code style="font-size: 10px; color: #DFB313;">${availableFields.slice(0, 20).join(', ')}${availableFields.length > 20 ? '...' : ''}</code>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = fieldsInfo + `
                <div class="following-list">
                    ${followingArray.slice(0, 50).map(user => {
                        const avatarUrl = user.profile_pic_url || user.profile_pic_url_hd || '';
                        const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
                        const username = user.username || 'N/A';
                        const fullName = user.full_name || '';
                        const isPrivate = user.is_private === true || user.is_private === 'true' || user.is_private === 1;
                        
                        return `
                            <div class="following-item" style="position: relative; padding: 12px;">
                                ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${username}" class="following-avatar" onclick="showImageModal('${proxyAvatarUrl}')" style="cursor: pointer;" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(){showImageModal('${avatarUrl}')};">` : '<div class="following-avatar" style="background: #517aff;"></div>'}
                                <div style="flex: 1;">
                                    <div class="following-name">
                                        ${fullName || username}
                                        ${isPrivate ? '<span style="color: #ef4444; font-size: 10px; margin-left: 5px;">üîí PRIVADO</span>' : '<span style="color: #22c55e; font-size: 10px; margin-left: 5px;">üåê P√öBLICO</span>'}
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">@${username}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${followingArray.length > 50 ? `<div style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.6);">... e mais ${followingArray.length - 50} usu√°rios</div>` : ''}
            `;
            
            jsonContainer.textContent = JSON.stringify(following, null, 2);
            document.getElementById('followingBadge').textContent = followingArray.length;
        }
        
        
        async function renderMutualPublicProfiles(username) {
            const container = document.getElementById('mutualData');
            const jsonContainer = document.getElementById('mutualJson');
            const section = document.getElementById('mutualSection');
            
            console.log('üîç Iniciando busca de perfis m√∫tuos...');
            console.log('üìã Container encontrado?', !!container);
            console.log('üìã Section encontrada?', !!section);
            
            if (!container || !section) {
                console.error('‚ùå Container ou section n√£o encontrados!');
                return;
            }
            
            // Sempre mostrar a se√ß√£o
            section.style.display = 'block';
            console.log('‚úÖ Se√ß√£o de perfis m√∫tuos exibida');
            
            console.log('üîç Buscando perfis m√∫tuos manualmente (comparando followers e following)...');
            
            let topMutualProfiles = [];
            
            try {
                // Buscar followers e following simultaneamente
                const [followersResponse, followingResponse] = await Promise.all([
                    fetch(getApiUrl(`/api/followers?username=${encodeURIComponent(username)}`)),
                    fetch(getApiUrl(`/api/following?username=${encodeURIComponent(username)}`))
                ]);
                
                let followersArray = [];
                let followingArray = [];
                
                if (followersResponse.ok) {
                    const followersData = await followersResponse.json();
                    if (Array.isArray(followersData)) {
                        followersArray = followersData;
                    } else if (followersData.followers && Array.isArray(followersData.followers)) {
                        followersArray = followersData.followers;
                    } else if (followersData.users && Array.isArray(followersData.users)) {
                        followersArray = followersData.users;
                    }
                }
                
                if (followingResponse.ok) {
                    const followingData = await followingResponse.json();
                    if (Array.isArray(followingData)) {
                        followingArray = followingData;
                    } else if (followingData.following && Array.isArray(followingData.following)) {
                        followingArray = followingData.following;
                    } else if (followingData.users && Array.isArray(followingData.users)) {
                        followingArray = followingData.users;
                    }
                }
                
                console.log('üìä Followers recebidos:', followersArray.length);
                console.log('üìä Following recebido:', followingArray.length);
                
                // Criar um Set de usernames dos followers para busca r√°pida
                // Normalizar: lowercase, trim, remover espa√ßos extras
                const followersUsernames = new Set(
                    followersArray
                        .map(f => f.username?.toLowerCase()?.trim())
                        .filter(Boolean)
                );
                const followersPks = new Set(
                    followersArray
                        .map(f => String(f.pk || f.id || '').trim())
                        .filter(pk => pk && pk !== 'undefined' && pk !== 'null')
                );
                
                console.log('üìä Followers usernames √∫nicos:', followersUsernames.size);
                console.log('üìä Followers PKs √∫nicos:', followersPks.size);
                
                // DEBUG: Mostrar alguns exemplos
                const sampleUsernames = Array.from(followersUsernames).slice(0, 5);
                const samplePks = Array.from(followersPks).slice(0, 5);
                console.log('üìä Exemplos de usernames nos followers:', sampleUsernames);
                console.log('üìä Exemplos de PKs nos followers:', samplePks);
                
                // Primeiro, verificar TODOS os perfis do following (incluindo privados) para encontrar m√∫tuos
                // Depois filtrar apenas os p√∫blicos para exibi√ß√£o
                const mutualProfiles = [];
                
                // DEBUG: Verificar se "Igor Belasque de Castro" est√° nas listas
                const debugUsername = 'igor.bcastro';
                const debugUserInFollowing = followingArray.find(u => u.username?.toLowerCase() === debugUsername.toLowerCase());
                const debugUserInFollowers = followersArray.find(u => u.username?.toLowerCase() === debugUsername.toLowerCase());
                
                if (debugUserInFollowing || debugUserInFollowers) {
                    console.log('üîç DEBUG - Igor Belasque de Castro:');
                    console.log('  - No following:', !!debugUserInFollowing, debugUserInFollowing ? {
                        username: debugUserInFollowing.username, 
                        pk: debugUserInFollowing.pk, 
                        id: debugUserInFollowing.id,
                        is_private: debugUserInFollowing.is_private
                    } : 'n√£o encontrado');
                    console.log('  - Nos followers:', !!debugUserInFollowers, debugUserInFollowers ? {
                        username: debugUserInFollowers.username, 
                        pk: debugUserInFollowers.pk,
                        id: debugUserInFollowers.id,
                        is_private: debugUserInFollowers.is_private
                    } : 'n√£o encontrado');
                    if (debugUserInFollowing) {
                        const isPrivate = debugUserInFollowing.is_private === true || debugUserInFollowing.is_private === 'true' || debugUserInFollowing.is_private === 1;
                        console.log('  - √â privado?', isPrivate);
                        console.log('  - Seria filtrado?', isPrivate);
                    }
                }
                
                // Verificar TODOS os perfis do following (n√£o filtrar por privado ainda)
                for (const user of followingArray) {
                    if (!user.username) continue;
                    
                    const usernameLower = user.username?.toLowerCase().trim();
                    const userPk = String(user.pk || user.id || '').trim();
                    
                    // Verificar por username (case-insensitive e trimmed)
                    let isMutual = false;
                    if (usernameLower) {
                        isMutual = followersUsernames.has(usernameLower);
                    }
                    
                    // Se n√£o encontrou por username, tentar por PK
                    if (!isMutual && userPk) {
                        isMutual = followersPks.has(userPk);
                    }
                    
                    // DEBUG para usu√°rios espec√≠ficos
                    if (usernameLower && usernameLower.includes('igor')) {
                        console.log(`üîç DEBUG @${user.username}:`);
                        console.log(`  - usernameLower: "${usernameLower}"`);
                        console.log(`  - Est√° no Set de usernames?`, followersUsernames.has(usernameLower));
                        console.log(`  - userPk: "${userPk}"`);
                        console.log(`  - Est√° no Set de PKs?`, followersPks.has(userPk));
                        console.log(`  - isMutual:`, isMutual);
                        console.log(`  - is_private:`, user.is_private);
                    }
                    
                    if (isMutual) {
                        const isPrivate = user.is_private === true || user.is_private === 'true' || user.is_private === 1;
                        mutualProfiles.push({
                            username: user.username,
                            full_name: user.full_name || '',
                            profile_pic_url: user.profile_pic_url || user.profile_pic_url_hd || '',
                            mutual_followers_count: 1,
                            is_private: isPrivate
                        });
                    }
                }
                
                console.log('üìä Total de perfis m√∫tuos encontrados (incluindo privados):', mutualProfiles.length);
                
                // Mostrar TODOS os m√∫tuos (p√∫blicos e privados), mas marcar os privados
                // Ordenar por mutual_followers_count (maior primeiro)
                mutualProfiles.sort((a, b) => (b.mutual_followers_count || 0) - (a.mutual_followers_count || 0));
                // Usar TODOS os perfis m√∫tuos encontrados, n√£o apenas top 3
                const topMutualProfiles = mutualProfiles;
                
                console.log('‚úÖ Perfis m√∫tuos encontrados (manual):', topMutualProfiles.length);
                console.log('üìä P√∫blicos:', topMutualProfiles.filter(p => !p.is_private).length);
                console.log('üìä Privados:', topMutualProfiles.filter(p => p.is_private).length);
                
                console.log('‚úÖ Todos os perfis m√∫tuos:', topMutualProfiles.map(p => `@${p.username} (${p.is_private ? 'PRIVADO' : 'P√öBLICO'})`));
                
                // Renderizar imediatamente ap√≥s encontrar
                if (!topMutualProfiles || topMutualProfiles.length === 0) {
                    container.innerHTML = '<div class="empty-state">Nenhum perfil m√∫tuo encontrado</div>';
                    jsonContainer.textContent = '[]';
                    document.getElementById('mutualBadge').textContent = '0';
                    return;
                }
                
                document.getElementById('mutualBadge').textContent = topMutualProfiles.length;
                
                console.log('üé® Renderizando', topMutualProfiles.length, 'perfis m√∫tuos na tela...');
                console.log('üìã Container antes da renderiza√ß√£o:', container);
                console.log('üìã Dados a renderizar:', topMutualProfiles);
                
                const htmlContent = `
                    <div class="following-list">
                        ${topMutualProfiles.map(profile => {
                            const avatarUrl = profile.profile_pic_url || '';
                            const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
                            const mutualCount = profile.mutual_followers_count || 0;
                            
                            console.log(`  - Renderizando @${profile.username} (${profile.is_private ? 'PRIVADO' : 'P√öBLICO'})`);
                            
                            return `
                                <div class="following-item" style="position: relative; padding: 12px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${profile.username}" class="following-avatar" onclick="showImageModal('${proxyAvatarUrl}')" style="cursor: pointer; width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(){showImageModal('${avatarUrl}')};">` : '<div class="following-avatar" style="background: #22c55e; width: 50px; height: 50px; border-radius: 50%;"></div>'}
                                    <div style="flex: 1; margin-left: 12px;">
                                        <div class="following-name" style="display: flex; align-items: center; gap: 8px;">
                                            <strong style="color: white;">${profile.full_name || profile.username}</strong>
                                            <span style="color: ${profile.is_private ? '#ef4444' : '#22c55e'}; font-size: 10px;">
                                                ${profile.is_private ? 'üîí PRIVADO' : 'üåê P√öBLICO'}
                                            </span>
                                        </div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 4px;">@${profile.username}</div>
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px;">
                                            <strong style="color: #DFB313;">üë• ${mutualCount} m√∫tuo(s)</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                console.log('üìã HTML gerado (primeiros 500 chars):', htmlContent.substring(0, 500));
                container.innerHTML = htmlContent;
                console.log('üìã Container.innerHTML definido, tamanho:', container.innerHTML.length);
                
                jsonContainer.textContent = JSON.stringify(topMutualProfiles, null, 2);
                console.log('‚úÖ Perfis m√∫tuos renderizados na tela!');
                console.log('üìã Container ap√≥s renderiza√ß√£o:', container);
                console.log('üìã Section display:', section.style.display);
                
            } catch (e) {
                console.error('‚ùå Erro ao buscar perfis m√∫tuos da API:', e);
                container.innerHTML = '<div class="empty-state">Erro ao carregar perfis m√∫tuos: ' + e.message + '</div>';
                jsonContainer.textContent = JSON.stringify({ error: e.message }, null, 2);
                document.getElementById('mutualBadge').textContent = '0';
                section.style.display = 'block';
            }
        }
        
        // Fun√ß√£o renderLastPosts removida - n√£o vamos mais usar busca de √∫ltimos posts
        
        // Fun√ß√£o para calcular relev√¢ncia de posts
        function calculatePostRelevance(post, isMutual = false) {
            if (!post) return -1000;
            
            const likes = post.likeCount || 0;
            const takenAt = post.takenAt || 0;
            
            // Posts com curtidas < 10 ou > 300 s√£o muito ruins
            if (likes < 10 || likes > 300) {
                return -1000;
            }
            
            // Calcular score de curtidas (favorece curtidas pr√≥ximas de 50)
            const distanceFrom50 = Math.abs(likes - 50);
            const likesScore = Math.max(0, 100 - (distanceFrom50 * 2)); // M√°ximo 100, decai 2 pontos por unidade de dist√¢ncia
            
            // Calcular score de data (posts mais recentes t√™m score maior)
            const now = Date.now();
            const postDate = takenAt * 1000; // Converter timestamp para milissegundos
            const daysAgo = (now - postDate) / (1000 * 60 * 60 * 24); // Dias desde o post
            const dateScore = Math.max(0, 100 - (daysAgo * 5)); // Decai 5 pontos por dia
            
            // Boost para perfis m√∫tuos (boost moderado)
            const mutualBoost = isMutual ? 30 : 0;
            
            // Score final: 50% curtidas + 50% data + boost m√∫tuo
            const finalScore = (likesScore * 0.5) + (dateScore * 0.5) + mutualBoost;
            
            return finalScore;
        }
        
        // Etapa 4: Buscar e renderizar posts dos perfis p√∫blicos
        async function renderLastPostsProfiles(followersData, followingData, userData, isMainProfilePrivate = false) {
            const container = document.getElementById('lastPostsData');
            const jsonContainer = document.getElementById('lastPostsJson');
            const section = document.getElementById('lastPostsSection');
            
            // Sempre mostrar a se√ß√£o
            section.style.display = 'block';
            
            let publicUsers = [];
            
            if (isMainProfilePrivate) {
                // Perfil privado: buscar 20 perfis P√öBLICOS sugeridos
                console.log('üîí Perfil privado detectado - buscando 25 perfis P√öBLICOS sugeridos');
                
                const chainingResults = userData?.user?.chaining_results || [];
                
                if (chainingResults && Array.isArray(chainingResults) && chainingResults.length > 0) {
                    console.log(`üîç Total de perfis SUGERIDOS recebidos: ${chainingResults.length}`);
                    
                    // üî• OTIMIZA√á√ÉO 3: Buscar 25 perfis ao inv√©s de 20
                    const suggestedPublic = [];
                    for (const profile of chainingResults) {
                        // Parar quando tiver 25 perfis p√∫blicos
                        if (suggestedPublic.length >= 25) break;
                        
                        // Verificar se √© P√öBLICO usando o campo is_private da API
                        const isPrivate = profile.is_private === true || profile.is_private === 'true' || profile.is_private === 1;
                        
                        if (isPrivate) {
                            console.log(`‚ùå Ignorando @${profile.username} - PRIVADO (is_private: ${profile.is_private})`);
                            continue; // Pular perfis privados
                        }
                        
                        if (profile.username) {
                            console.log(`‚úÖ Adicionando @${profile.username} - P√öBLICO (is_private: ${profile.is_private})`);
                            suggestedPublic.push({
                                username: profile.username,
                                full_name: profile.full_name || '',
                                profile_pic_url: profile.profile_pic_url || profile.profile_pic_url_hd || '',
                                source: 'suggested',
                                is_private: profile.is_private // Manter o valor original da API
                            });
                        }
                    }
                    
                    publicUsers = suggestedPublic;
                    console.log(`‚úÖ ${publicUsers.length} perfis P√öBLICOS sugeridos coletados (de ${chainingResults.length} total)`);
                    console.log(`üìã Perfis P√öBLICOS (at√© 25): ${publicUsers.map(p => '@' + p.username).join(', ')}`);
                } else {
                    console.warn('‚ö†Ô∏è Nenhum perfil sugerido encontrado para perfil privado');
                }
            } else {
                // Perfil p√∫blico: buscar 25 perfis P√öBLICOS de following
                console.log('üåê Perfil p√∫blico detectado - buscando 25 perfis P√öBLICOS de SEGUINDO');
                
                if (followingData) {
                    let followingArray = [];
                    if (Array.isArray(followingData)) {
                        followingArray = followingData;
                    } else if (followingData.following && Array.isArray(followingData.following)) {
                        followingArray = followingData.following;
                    } else if (followingData.users && Array.isArray(followingData.users)) {
                        followingArray = followingData.users;
                    }
                    
                    console.log(`üîç Total de perfis SEGUINDO recebidos: ${followingArray.length}`);
                    
                    // üî• OTIMIZA√á√ÉO 3: Buscar 25 perfis ao inv√©s de 20
                    const followingPublic = [];
                    for (const user of followingArray) {
                        // Parar quando tiver 25 perfis p√∫blicos
                        if (followingPublic.length >= 25) break;
                        
                        // Verificar se √© P√öBLICO usando o campo is_private da API
                        const isPrivate = user.is_private === true || user.is_private === 'true' || user.is_private === 1;
                        
                        if (isPrivate) {
                            console.log(`‚ùå Ignorando @${user.username} - PRIVADO (is_private: ${user.is_private})`);
                            continue; // Pular perfis privados
                        }
                        
                        if (user.username) {
                            console.log(`‚úÖ Adicionando @${user.username} - P√öBLICO (is_private: ${user.is_private})`);
                            followingPublic.push({
                                username: user.username,
                                full_name: user.full_name || '',
                                profile_pic_url: user.profile_pic_url || user.profile_pic_url_hd || '',
                                source: 'following',
                                is_private: user.is_private // Manter o valor original da API
                            });
                        }
                    }
                    
                    publicUsers = followingPublic;
                    console.log(`‚úÖ ${publicUsers.length} perfis P√öBLICOS de SEGUINDO coletados (de ${followingArray.length} total)`);
                    console.log(`üìã Perfis P√öBLICOS (at√© 25): ${publicUsers.map(p => '@' + p.username).join(', ')}`);
                }
            }
            
            if (publicUsers.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum perfil p√∫blico encontrado para buscar posts</div>';
                jsonContainer.textContent = '[]';
                document.getElementById('lastPostsBadge').textContent = '0';
                return;
            }
            
            // Valida√ß√£o final: garantir que todos s√£o p√∫blicos
            console.log(`üîç Valida√ß√£o final dos ${publicUsers.length} perfis:`);
            const validatedPublicUsers = publicUsers.filter(p => {
                const isPrivate = p.is_private === true || p.is_private === 'true' || p.is_private === 1;
                console.log(`   - @${p.username}: is_private=${p.is_private} (${isPrivate ? 'PRIVADO ‚ùå' : 'P√öBLICO ‚úÖ'})`);
                if (isPrivate) {
                    console.warn(`‚ö†Ô∏è ERRO: Perfil PRIVADO passou pelo filtro inicial: @${p.username} (is_private: ${p.is_private})`);
                    return false;
                }
                return true;
            });
            
            console.log(`üìä Buscando posts de ${validatedPublicUsers.length} perfis P√öBLICOS`);
            console.log(`üîç Perfis selecionados: ${validatedPublicUsers.map(p => '@' + p.username).join(', ')}`);
            
            // Mostrar loading
            container.innerHTML = '<div class="empty-state">Carregando posts...</div>';
            
            // Buscar posts usando BATCH (1 requisi√ß√£o ao inv√©s de 20)
            console.log(`üî• Iniciando busca BATCH de ${validatedPublicUsers.length} posts...`);
            const postsPromisesStart = performance.now();
            
            // Extrair apenas os usernames
            const usernames = validatedPublicUsers.map(p => p.username);
            
            // Fazer batch request
            const batchResults = await fetchPostsBatch(usernames);
            
            // Mapear resultados de volta aos perfis
            const batchResultsMap = new Map(batchResults.map(r => [r.username, r]));
            
            const profilesWithPosts = validatedPublicUsers.map(profile => {
                const result = batchResultsMap.get(profile.username);
                const post = result?.success && result.post ? extractPostData(result.post) : null;
                
                if (result) {
                    console.log(`   ${result.success && result.post ? '‚úÖ' : '‚ùå'} @${profile.username}`);
                }
                
                return {
                    ...profile,
                    post: post
                };
            });
            
            const postsPromisesEnd = performance.now();
            console.log(`üî• Total busca BATCH de posts: ${(postsPromisesEnd - postsPromisesStart).toFixed(0)}ms`);
            
            // Filtrar apenas perfis que t√™m posts v√°lidos (com imagem)
            let profilesWithPostsFiltered = profilesWithPosts.filter(p => {
                return p.post !== null && p.post.imageUrl && p.post.imageUrl.length > 0;
            });
            
            console.log(`‚úÖ Posts v√°lidos encontrados: ${profilesWithPostsFiltered.length} de ${validatedPublicUsers.length} perfis P√öBLICOS`);
            
            // Para perfis p√∫blicos, obter lista de usernames m√∫tuos para c√°lculo de relev√¢ncia
            let mutualUsernames = new Set();
            if (!isMainProfilePrivate && followersData && followingData) {
                try {
                    // Extrair arrays de followers e following
                    let followersArray = [];
                    if (Array.isArray(followersData)) {
                        followersArray = followersData;
                    } else if (followersData.followers && Array.isArray(followersData.followers)) {
                        followersArray = followersData.followers;
                    } else if (followersData.users && Array.isArray(followersData.users)) {
                        followersArray = followersData.users;
                    }
                    
                    let followingArray = [];
                    if (Array.isArray(followingData)) {
                        followingArray = followingData;
                    } else if (followingData.following && Array.isArray(followingData.following)) {
                        followingArray = followingData.following;
                    } else if (followingData.users && Array.isArray(followingData.users)) {
                        followingArray = followingData.users;
                    }
                    
                    // Criar Sets de usernames (case-insensitive)
                    const followersUsernames = new Set(followersArray.map(u => u.username?.toLowerCase().trim()).filter(Boolean));
                    
                    // Identificar m√∫tuos
                    followingArray.forEach(user => {
                        const usernameLower = user.username?.toLowerCase().trim();
                        if (usernameLower && followersUsernames.has(usernameLower)) {
                            mutualUsernames.add(usernameLower);
                        }
                    });
                    
                    console.log(`üìä Perfis m√∫tuos identificados para relev√¢ncia: ${mutualUsernames.size}`);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao identificar perfis m√∫tuos para relev√¢ncia:', e);
                }
            }
            
            // Calcular relev√¢ncia para cada post e ordenar
            profilesWithPostsFiltered = profilesWithPostsFiltered.map(profile => {
                const isMutual = mutualUsernames.has(profile.username?.toLowerCase().trim());
                const relevanceScore = calculatePostRelevance(profile.post, isMutual);
                return {
                    ...profile,
                    relevanceScore: relevanceScore,
                    isMutual: isMutual
                };
            });
            
            // Ordenar por relev√¢ncia (maior score primeiro)
            profilesWithPostsFiltered.sort((a, b) => b.relevanceScore - a.relevanceScore);
            
            console.log(`üìä Posts ordenados por relev√¢ncia:`);
            profilesWithPostsFiltered.slice(0, 5).forEach((p, idx) => {
                const date = p.post?.takenAt ? new Date(p.post.takenAt * 1000).toLocaleDateString('pt-BR') : 'N/A';
                const daysAgo = p.post?.takenAt ? Math.floor((Date.now() - (p.post.takenAt * 1000)) / (1000 * 60 * 60 * 24)) : 'N/A';
                console.log(`   ${idx + 1}. @${p.username} - ${date} (${daysAgo} dias atr√°s) - ${p.post?.likeCount} likes - Score: ${p.relevanceScore.toFixed(2)} ${p.isMutual ? '(M√öTUO)' : ''}`);
            });
            
            if (profilesWithPostsFiltered.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum post dispon√≠vel para os perfis selecionados</div>';
                jsonContainer.textContent = JSON.stringify(profilesWithPosts, null, 2);
                document.getElementById('lastPostsBadge').textContent = '0';
                return;
            }
            
            document.getElementById('lastPostsBadge').textContent = profilesWithPostsFiltered.length;
            
            // Renderizar cards com posts
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    ${profilesWithPostsFiltered.map((profile, index) => {
                        const avatarUrl = profile.profile_pic_url || '';
                        const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
                        const post = profile.post;
                        const postImageUrl = post.imageUrl || '';
                        const proxyPostUrl = postImageUrl ? getProxyImageUrl(postImageUrl) : '';
                        const instagramUrl = post.code ? `https://www.instagram.com/p/${post.code}/` : '';
                        const captionTruncated = post.caption ? (post.caption.length > 100 ? post.caption.substring(0, 100) + '...' : post.caption) : '';
                        const dateFormatted = post.takenAt ? new Date(post.takenAt * 1000).toLocaleDateString('pt-BR') : '';
                        
                        // Destacar os 3 posts mais relevantes
                        const isTop3 = index < 3;
                        const borderStyle = isTop3 ? '3px solid #DFB313' : '1px solid rgba(223, 179, 19, 0.3)';
                        const backgroundStyle = isTop3 ? 'rgba(0, 0, 0, 0.4)' : 'rgba(0, 0, 0, 0.3)';
                        const badgeStyle = isTop3 ? 'display: block;' : 'display: none;';
                        const isMutual = profile.isMutual || false;
                
                return `
                            <div style="background: ${backgroundStyle}; border-radius: 12px; padding: 15px; border: ${borderStyle}; position: relative;">
                                ${isTop3 ? `
                                    <div style="position: absolute; top: 10px; right: 10px; background: #DFB313; color: #000; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; z-index: 10;">
                                        üî• Mais Relevante
                                    </div>
                                ` : ''}
                                ${isMutual ? `
                                    <div style="position: absolute; top: 10px; left: 10px; background: #22c55e; color: #000; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; z-index: 10;">
                                        üë• M√∫tuo
                                    </div>
                                ` : ''}
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${profile.username}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="showImageModal('${proxyAvatarUrl}')" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(){showImageModal('${avatarUrl}')};">` : '<div style="width: 50px; height: 50px; border-radius: 50%; background: #DFB313;"></div>'}
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: white;">${profile.full_name || profile.username}</div>
                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">@${profile.username}</div>
                                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 2px;">
                                            ${profile.source === 'followers' ? 'üë• Seguidor' : profile.source === 'following' ? '‚û°Ô∏è Seguindo' : 'üîó Sugerido'}
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    ${instagramUrl ? `<a href="${instagramUrl}" target="_blank" style="color: #60a5fa; text-decoration: none; font-size: 11px; display: block; margin-bottom: 8px;">üîó Ver no Instagram</a>` : ''}
                                    <a href="${postImageUrl}" target="_blank" style="display: block;">
                                        <img src="${proxyPostUrl}" alt="Post de ${profile.username}" style="width: 100%; max-width: 200px; height: auto; border-radius: 8px; cursor: pointer; border: 2px solid #DFB313;" onclick="event.preventDefault(); showImageModal('${proxyPostUrl}')" onerror="this.style.display='none';">
                                    </a>
                                    <div style="margin-top: 8px; display: flex; gap: 15px; font-size: 11px; color: rgba(255,255,255,0.7); flex-wrap: wrap;">
                                        <span>‚ù§Ô∏è ${formatNumber(post.likeCount)}</span>
                                        <span>üí¨ ${formatNumber(post.commentCount)}</span>
                                        ${post.reshareCount > 0 ? `<span>‚û°Ô∏è ${formatNumber(post.reshareCount)}</span>` : ''}
                                        ${post.repostCount > 0 ? `<span>üîÑ ${formatNumber(post.repostCount)}</span>` : ''}
                                    </div>
                                    ${captionTruncated ? `<div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.4;">${captionTruncated}</div>` : ''}
                                    ${dateFormatted ? `<div style="margin-top: 6px; font-size: 10px; color: rgba(255,255,255,0.5);">üìÖ ${dateFormatted}</div>` : ''}
                                </div>
                    </div>
                `;
                    }).join('')}
                </div>
            `;
            
            jsonContainer.textContent = JSON.stringify(profilesWithPostsFiltered, null, 2);
            
            // Resumo de performance da busca de posts
            console.log(`\nüìä RESUMO - Busca de Posts:`);
            console.log(`   ‚îú‚îÄ Perfis analisados: ${validatedPublicUsers.length}`);
            console.log(`   ‚îú‚îÄ Posts encontrados: ${profilesWithPosts.filter(p => p.post).length}/${validatedPublicUsers.length}`);
            console.log(`   ‚îú‚îÄ Posts v√°lidos (com imagem): ${profilesWithPostsFiltered.length}`);
            console.log(`   ‚îú‚îÄ Tempo total: ${(postsPromisesEnd - postsPromisesStart).toFixed(0)}ms`);
            console.log(`   ‚îî‚îÄ M√©dia por post: ${((postsPromisesEnd - postsPromisesStart) / validatedPublicUsers.length).toFixed(0)}ms`);
        }
        
        // Etapa 3: Fun√ß√µes para buscar e extrair dados de posts
        function extractPostData(post) {
            if (!post) return null;
            
            // üî• OTIMIZA√á√ÉO 1: FILTRAR APENAS IMAGENS (excluir v√≠deos)
            // media_type: 1 = foto, 2 = v√≠deo, 8 = v√≠deo/IGTV
            const mediaType = post.media_type || post.type;
            
            if (mediaType === 2 || mediaType === 8 || mediaType === 'video') {
                console.log(`   ‚ö†Ô∏è Post ignorado: √© v√≠deo (media_type: ${mediaType})`);
                return null;
            }
            
            // Extrair URL da imagem (tentar v√°rios caminhos)
            let imageUrl = '';
            if (post.image_versions2?.candidates?.[0]?.url) {
                imageUrl = post.image_versions2.candidates[0].url;
            } else if (post.image_versions2?.candidates?.[1]?.url) {
                imageUrl = post.image_versions2.candidates[1].url;
            } else if (post.image_url) {
                imageUrl = post.image_url;
            } else if (post.thumbnail_url) {
                imageUrl = post.thumbnail_url;
            } else if (post.display_url) {
                imageUrl = post.display_url;
            } else if (post.carousel_media?.[0]?.image_versions2?.candidates?.[0]?.url) {
                imageUrl = post.carousel_media[0].image_versions2.candidates[0].url;
            }
            
            // Se n√£o tem imagem, rejeitar
            if (!imageUrl) {
                console.log(`   ‚ö†Ô∏è Post ignorado: sem URL de imagem`);
                return null;
            }
            
            // Extrair dados de repost/encaminhamento (tentar v√°rios campos poss√≠veis)
            const reshareCount = post.reshare_count || post.reshare || post.forward_count || post.forward || 0;
            const repostCount = post.repost_count || post.repost || post.share_count || post.share || 0;
            
            // Log para debug se encontrar algum valor
            if (reshareCount > 0 || repostCount > 0) {
                console.log(`üîÑ Post ${post.pk || post.id}: reshare=${reshareCount}, repost=${repostCount}`);
                console.log(`   Campos dispon√≠veis:`, Object.keys(post).filter(k => 
                    k.toLowerCase().includes('share') || 
                    k.toLowerCase().includes('repost') || 
                    k.toLowerCase().includes('forward') ||
                    k.toLowerCase().includes('reshare')
                ));
            }
            
            // Corrigir timestamp (pode vir em segundos ou milissegundos)
            let timestamp = post.taken_at || post.created_time || post.timestamp || 0;
            // Se for string, tentar parsear
            if (typeof timestamp === 'string') {
                timestamp = new Date(timestamp).getTime() / 1000; // Converter para segundos
            }
            // Se o timestamp for muito grande, est√° em milissegundos, converter para segundos
            if (timestamp > 10000000000) {
                timestamp = timestamp / 1000;
            }
            
            return {
                id: post.pk || post.id,
                code: post.code || post.shortcode,
                imageUrl: imageUrl,
                likeCount: post.like_count || 0,
                commentCount: post.comment_count || 0,
                reshareCount: reshareCount,
                repostCount: repostCount,
                caption: post.caption?.text || '',
                takenAt: timestamp,
                mediaType: post.media_type || post.type || 'photo'
            };
        }
        
        // Novo: Buscar posts em batch (m√∫ltiplos perfis de uma vez)
        async function fetchPostsBatch(usernames) {
            const fetchStart = performance.now();
            try {
                console.log(`üî• BATCH REQUEST: Buscando ${usernames.length} perfis de uma vez`);
                const response = await fetch(getApiUrl('/api/posts/batch'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ usernames, limit: 1 })
                });
                
                const fetchEnd = performance.now();
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üî• BATCH RESPONSE: ${(fetchEnd - fetchStart).toFixed(0)}ms total`);
                    return data.results; // Array de { username, success, post }
            } else {
                    console.warn(`‚ö†Ô∏è Erro no batch: ${response.status} (${(fetchEnd - fetchStart).toFixed(0)}ms)`);
                    return [];
                }
            } catch (error) {
                const fetchEnd = performance.now();
                console.warn(`‚ö†Ô∏è Erro no batch: ${error} (${(fetchEnd - fetchStart).toFixed(0)}ms)`);
                return [];
            }
        }
        
        async function fetchUserPosts(username, limit = null) {
            const fetchStart = performance.now();
            try {
                let url = `/api/user/posts?username=${encodeURIComponent(username)}`;
                if (limit) {
                    url += `&limit=${limit}`;
                }
                const response = await fetch(getApiUrl(url));
                const fetchEnd = performance.now();
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`      ‚îî‚îÄ üåê API response: ${(fetchEnd - fetchStart).toFixed(0)}ms`);
                    return data.posts || [];
            } else {
                    console.warn(`‚ö†Ô∏è Erro ao buscar posts de @${username}: ${response.status} (${(fetchEnd - fetchStart).toFixed(0)}ms)`);
                    return null;
                }
            } catch (error) {
                const fetchEnd = performance.now();
                console.warn(`‚ö†Ô∏è Erro ao buscar posts de @${username}: ${error} (${(fetchEnd - fetchStart).toFixed(0)}ms)`);
                return null;
            }
        }
        
        async function fetchPostDetails(postId) {
            try {
                const response = await fetch(getApiUrl(`/api/post?id=${encodeURIComponent(postId)}`));
                if (response.ok) {
                    const post = await response.json();
                    return post;
                } else {
                    console.warn(`‚ö†Ô∏è Erro ao buscar detalhes do post ${postId}:`, response.status);
                    return null;
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è Erro ao buscar detalhes do post ${postId}:`, error);
                return null;
            }
        }
        
        async function getLatestPost(username) {
            try {
                // Buscar apenas o post mais recente (limit=1)
                const posts = await fetchUserPosts(username, 1);
                
                if (!posts || posts.length === 0) {
                    return null;
                }
                
                // A API j√° retorna ordenado por data, ent√£o o primeiro √© o mais recente
                // Usar diretamente os dados do post sem fazer requisi√ß√£o adicional
                const latestPost = posts[0];
                return extractPostData(latestPost);
            } catch (error) {
                console.warn(`‚ö†Ô∏è Erro ao buscar √∫ltimo post de @${username}:`, error);
                return null;
            }
        }
        
        async function renderChainingResults(chainingResults, originalUsername) {
            const container = document.getElementById('chainingData');
            const jsonContainer = document.getElementById('chainingJson');
            
            if (!chainingResults || !Array.isArray(chainingResults) || chainingResults.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum perfil sugerido encontrado</div>';
                jsonContainer.textContent = '[]';
                document.getElementById('chainingBadge').textContent = '0';
                return;
            }
            
            // N√ÉO SALVAR NADA - P√°gina de debug apenas visualiza
            
            // Analisar campos dispon√≠veis no primeiro perfil sugerido
            const firstProfile = chainingResults[0];
            const availableFields = firstProfile ? Object.keys(firstProfile) : [];
            const hasIsPrivate = availableFields.includes('is_private');
            
            // Mostrar informa√ß√µes sobre campos dispon√≠veis (simplificado)
            let fieldsInfo = '';
            if (hasIsPrivate) {
                fieldsInfo = `
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border: 1px solid #3b82f6;">
                        <strong style="color: #93c5fd;">üìä Campos Dispon√≠veis:</strong>
                        <div style="margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.9);">
                            ${hasIsPrivate ? '‚úÖ is_private<br>' : '‚ùå is_private<br>'}
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <strong>Pr√©via dos campos (${availableFields.length} total):</strong><br>
                                <code style="font-size: 10px; color: #DFB313;">${availableFields.slice(0, 20).join(', ')}${availableFields.length > 20 ? '...' : ''}</code>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Renderizar lista de perfis sugeridos
            container.innerHTML = fieldsInfo + `
                <div class="following-list">
                    ${chainingResults.slice(0, 20).map((profile, index) => {
                        const avatarUrl = profile.profile_pic_url || profile.profile_pic_url_hd || '';
                        const proxyAvatarUrl = getProxyImageUrl(avatarUrl);
                        const username = profile.username || 'N/A';
                        const fullName = profile.full_name || '';
                        const isPrivate = profile.is_private === true || profile.is_private === 'true' || profile.is_private === 1;
                        
                        return `
                            <div class="following-item" style="cursor: pointer; position: relative; padding: 12px;" onclick="loadChainingProfile('${username}')">
                                ${avatarUrl ? `<img src="${proxyAvatarUrl}" alt="${username}" class="following-avatar" onclick="event.stopPropagation(); showImageModal('${proxyAvatarUrl}')" style="cursor: pointer;" onerror="this.onerror=null; this.src='${avatarUrl}'; this.onclick=function(e){e.stopPropagation(); showImageModal('${avatarUrl}')};">` : '<div class="following-avatar" style="background: #517aff;"></div>'}
                                <div style="flex: 1;">
                                    <div class="following-name">
                                        ${fullName || username} 
                                        ${isPrivate ? '<span style="color: #ef4444; font-size: 10px;">üîí PRIVADO</span>' : '<span style="color: #22c55e; font-size: 10px;">üåê P√öBLICO</span>'}
                                        <span style="color: #DFB313; font-size: 10px; margin-left: 5px;">[Clique para buscar dados]</span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">@${username}</div>
                                    ${profile.follower_count ? `<div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px;">${formatNumber(profile.follower_count)} seguidores</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${chainingResults.length > 20 ? `<div style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.6);">... e mais ${chainingResults.length - 20} perfis sugeridos</div>` : ''}
                <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; border: 1px solid #3b82f6;">
                    <strong style="color: #93c5fd;">üí° Dica:</strong>
                    <div style="color: rgba(255,255,255,0.8); margin-top: 8px; font-size: 14px;">
                        Para perfis privados, clique em um perfil sugerido acima para buscar seus dados (following, followers, stories). 
                        Esses perfis geralmente s√£o p√∫blicos ou t√™m mais informa√ß√µes dispon√≠veis.
                    </div>
                </div>
            `;
            
            jsonContainer.textContent = JSON.stringify(chainingResults, null, 2);
            document.getElementById('chainingBadge').textContent = chainingResults.length;
        }
        
        async function loadChainingProfile(username) {
            if (!username) return;
            
            showStatus(`Buscando dados do perfil sugerido: ${username}...`, 'loading');
            
            try {
                // Buscar dados do perfil sugerido
                const [userResponse, followingResponse, followersResponse] = await Promise.all([
                    fetch(getApiUrl(`/api/user?username=${encodeURIComponent(username)}`)).catch(e => ({ ok: false, error: e })),
                    fetch(getApiUrl(`/api/following?username=${encodeURIComponent(username)}`)).catch(e => ({ ok: false, error: e })),
                    fetch(getApiUrl(`/api/followers?username=${encodeURIComponent(username)}`)).catch(e => ({ ok: false, error: e }))
                ]);
                
                let userData = null;
                let followingData = null;
                let followersData = null;
                
                if (userResponse.ok) {
                    userData = await userResponse.json();
                    console.log('‚úÖ Dados do perfil sugerido recebidos:', userData);
                }
                
                if (followingResponse.ok) {
                    followingData = await followingResponse.json();
                    console.log('‚úÖ Following do perfil sugerido recebido:', followingData);
                    
                    // N√ÉO SALVAR NADA - P√°gina de debug apenas visualiza
                }
                
                if (followersResponse.ok) {
                    followersData = await followersResponse.json();
                    console.log('‚úÖ Followers do perfil sugerido recebido:', followersData);
                    
                    // N√ÉO SALVAR NADA - P√°gina de debug apenas visualiza
                }
                
                // Atualizar se√ß√µes com dados do perfil sugerido
                if (userData) {
                    renderUserData(userData, username);
                }
                if (followingData) {
                    renderFollowingData(followingData);
                }
                if (followersData) {
                    renderFollowersData(followersData);
                }
                
                // Verificar se √© privado para decidir o que buscar
                const isPrivate = userData?.user?.is_private === true || userData?.user?.is_private === 'true' || userData?.user?.is_private === 1;
                
                // Buscar perfis m√∫tuos APENAS para perfis p√∫blicos
                if (!isPrivate) {
                    document.getElementById('mutualSection').style.display = 'block';
                    await renderMutualPublicProfiles(username);
                }
                
                // Renderizar posts baseado no tipo de perfil
                await renderLastPostsProfiles(followersData, followingData, userData, isPrivate);
                
                showStatus(`‚úÖ Dados do perfil ${username} carregados! Verifique as se√ß√µes acima.`, 'success');
                
                // Salvar username no sessionStorage para manter ap√≥s F5
                sessionStorage.setItem('debug_last_username', username);
                
                // Scroll para o topo para ver os dados
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Erro ao buscar perfil sugerido:', error);
                showStatus(`Erro ao buscar dados: ${error.message}`, 'error');
            }
        }
        
        async function searchUser() {
            console.time('‚è±Ô∏è TEMPO TOTAL DA BUSCA');
            const searchStartTime = performance.now();
            
            const input = document.getElementById('usernameInput');
            const btn = document.getElementById('searchBtn');
            let username = input.value.trim();
            
            // Remover @ se houver
            if (username.startsWith('@')) {
                username = username.substring(1);
            }
            
            if (!username) {
                showStatus('Por favor, digite um username', 'error');
                return;
            }
            
            btn.disabled = true;
            showStatus('Buscando dados...', 'loading');
            document.getElementById('results').style.display = 'none';
            
            // Resetar se√ß√µes ao iniciar nova busca (ser√£o mostradas/ocultadas baseado no tipo de perfil)
            document.getElementById('chainingSection').style.display = 'none';
            document.getElementById('mutualSection').style.display = 'none';
            document.getElementById('followersSection').style.display = 'none';
            document.getElementById('followingSection').style.display = 'none';
            
            try {
                // Verificar se o servidor est√° acess√≠vel primeiro
                const apiUrl = getApiUrl(`/api/user?username=${encodeURIComponent(username)}`);
                console.log('üîç Buscando usu√°rio na URL:', apiUrl);
                
                console.time('‚è±Ô∏è 1. API /api/user');
                const userFetchStart = performance.now();
                
                // Buscar apenas dados do usu√°rio primeiro
                const userResponse = await fetch(apiUrl).catch(e => {
                        console.error('‚ùå Erro de conex√£o ao buscar usu√°rio:', e);
                        return { ok: false, error: e, status: 0 };
                });
                
                const userFetchEnd = performance.now();
                console.timeEnd('‚è±Ô∏è 1. API /api/user');
                console.log(`   ‚îî‚îÄ Tempo: ${(userFetchEnd - userFetchStart).toFixed(0)}ms`);
                
                // Verificar erros de conex√£o
                if (userResponse.error || userResponse.status === 0) {
                    showStatus('‚ùå Erro de conex√£o. Verifique se o servidor est√° rodando na porta 8002.', 'error');
                    btn.disabled = false;
                    return;
                }
                
                let userData = null;
                if (userResponse.ok) {
                    try {
                    userData = await userResponse.json();
                    } catch (e) {
                        console.error('‚ùå Erro ao parsear resposta do usu√°rio:', e);
                        const errorText = await userResponse.text().catch(() => 'Erro desconhecido');
                        console.error('Resposta recebida:', errorText);
                        showStatus(`Erro ao processar dados do usu√°rio: ${e.message}`, 'error');
                        btn.disabled = false;
                        return;
                    }
                    
                    // N√ÉO SALVAR NADA - P√°gina de debug apenas visualiza
                    if (userData && userData.user) {
                        const u = userData.user;
                        const userUsername = u.username || username; // Usar username do input se n√£o vier na resposta
                        
                        // Apenas logar informa√ß√µes (sem salvar)
                        console.log('üîç Verificando chaining_results para:', userUsername);
                        console.log('üìã has_chaining:', u.has_chaining);
                        console.log('üìã chaining_results existe?', 'chaining_results' in u);
                        console.log('üìã chaining_results tipo:', typeof u.chaining_results);
                        console.log('üìã chaining_results √© array?', Array.isArray(u.chaining_results));
                        
                        if (u.chaining_results && Array.isArray(u.chaining_results) && u.chaining_results.length > 0) {
                            console.log('‚úÖ Chaining results encontrados (N√ÉO SALVOS - apenas visualiza√ß√£o):', userUsername, '-', u.chaining_results.length, 'perfis sugeridos');
                            console.log('üìã Primeiros 3 perfis sugeridos:', u.chaining_results.slice(0, 3).map(p => p.username || 'N/A'));
                        } else {
                            console.warn('‚ö†Ô∏è Nenhum chaining_results encontrado na resposta da API para:', userUsername);
                            if (u.has_chaining) {
                                console.warn('‚ö†Ô∏è Mas has_chaining √© true! A API pode n√£o retornar chaining_results para este perfil espec√≠fico.');
                            }
                            // Verificar se est√° em outro formato ou localiza√ß√£o
                            const allKeys = Object.keys(u);
                            const chainKeys = allKeys.filter(k => k.toLowerCase().includes('chain'));
                            console.log('üìã Chaves relacionadas a chain:', chainKeys);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Resposta do usu√°rio n√£o cont√©m user:', userData);
                        showStatus('‚ö†Ô∏è Dados do usu√°rio incompletos. Verifique o console para mais detalhes.', 'error');
                        btn.disabled = false;
                        return;
                    }
                } else {
                    // Se n√£o foi OK, tentar ler a mensagem de erro
                    let errorText = 'Erro desconhecido';
                    let errorJson = null;
                    try {
                        errorText = await userResponse.text();
                        try {
                            errorJson = JSON.parse(errorText);
                        } catch (e) {
                            // N√£o √© JSON, usar texto direto
                        }
                    } catch (e) {
                        console.error('Erro ao ler resposta:', e);
                    }
                    
                    // Mensagem de erro mais clara
                    let errorMessage = '';
                    if (userResponse.status === 404) {
                        if (errorJson && errorJson.detail) {
                            errorMessage = `‚ùå Usu√°rio "${username}" n√£o encontrado. Verifique se o username est√° correto ou se o perfil existe no Instagram.`;
                        } else {
                            errorMessage = `‚ùå Usu√°rio "${username}" n√£o encontrado. Verifique se o username est√° correto.`;
                        }
                        // N√£o logar como erro cr√≠tico, apenas aviso
                        console.warn('‚ö†Ô∏è Usu√°rio n√£o encontrado:', username);
                    } else {
                        errorMessage = `Erro ${userResponse.status}: ${errorJson?.error || errorJson?.message || errorJson?.detail || errorText || 'Erro desconhecido'}`;
                    console.error('‚ùå Erro ao buscar usu√°rio:', userResponse.status, errorText);
                    }
                    
                    showStatus(errorMessage, 'error');
                    btn.disabled = false;
                    return;
                }
                
                // Verificar se √© privado ou p√∫blico para decidir o que buscar
                const isPrivate = userData?.user?.is_private === true || userData?.user?.is_private === 'true' || userData?.user?.is_private === 1;
                
                // Verificar se pelo menos os dados do usu√°rio foram carregados
                if (!userData || !userData.user) {
                    showStatus('‚ùå N√£o foi poss√≠vel carregar os dados do usu√°rio. Verifique se o servidor est√° rodando na porta 8002.', 'error');
                    btn.disabled = false;
                    return;
                }
                
                // Renderizar dados do usu√°rio IMEDIATAMENTE
                renderUserData(userData, username);
                
                console.log('üìä Iniciando paraleliza√ß√£o m√°xima...');
                console.log('üöÄ Posts, followers/following e m√∫tuos v√£o buscar EM PARALELO!');
                
                // üî• PARALELIZA√á√ÉO M√ÅXIMA: Iniciar TUDO ao mesmo tempo
                const parallelStart = performance.now();
                
                let followersData = null;
                let followingData = null;
                
                // Criar array de promises para executar em paralelo
                const parallelPromises = [];
                
                // Se for P√öBLICO, buscar followers, following E m√∫tuos em paralelo
                if (!isPrivate) {
                    console.log('üåê Perfil p√∫blico - iniciando followers, following, m√∫tuos E posts em PARALELO');
                    
                    // Promise 1: Buscar followers e following juntos
                    const followersFollowingPromise = (async () => {
                        console.time('‚è±Ô∏è 2. API followers + following');
                        const start = performance.now();
                        
                        const [followersResponse, followingResponse] = await Promise.all([
                            fetch(getApiUrl(`/api/followers?username=${encodeURIComponent(username)}`)).catch(e => {
                                console.error('‚ùå Erro ao buscar followers:', e);
                                return { ok: false, error: e, status: 0 };
                            }),
                            fetch(getApiUrl(`/api/following?username=${encodeURIComponent(username)}`)).catch(e => {
                                console.error('‚ùå Erro ao buscar following:', e);
                                return { ok: false, error: e, status: 0 };
                            })
                        ]);
                
                if (followersResponse.ok) {
                    followersData = await followersResponse.json();
                }
                
                if (followingResponse.ok) {
                    followingData = await followingResponse.json();
                        }
                        
                        const end = performance.now();
                        console.timeEnd('‚è±Ô∏è 2. API followers + following');
                        console.log(`   ‚îî‚îÄ Tempo: ${(end - start).toFixed(0)}ms`);
                        
                        // Renderizar assim que terminar
                        if (followersData || followingData) {
                            document.getElementById('followersSection').style.display = 'block';
                            document.getElementById('followingSection').style.display = 'block';
                            renderFollowersData(followersData);
                            renderFollowingData(followingData);
                        }
                        
                        return { followersData, followingData };
                    })();
                    
                    // Promise 2: Buscar m√∫tuos (que depende de followers/following internamente)
                    const mutualsPromise = (async () => {
                        // Esperar followers/following antes de processar m√∫tuos
                        await followersFollowingPromise;
                        
                        console.time('‚è±Ô∏è 3. Busca de perfis m√∫tuos');
                        const start = performance.now();
                        
                        document.getElementById('mutualSection').style.display = 'block';
                        await renderMutualPublicProfiles(username);
                        
                        const end = performance.now();
                        console.timeEnd('‚è±Ô∏è 3. Busca de perfis m√∫tuos');
                        console.log(`   ‚îî‚îÄ Tempo: ${(end - start).toFixed(0)}ms`);
                    })();
                    
                    parallelPromises.push(followersFollowingPromise, mutualsPromise);
                } else {
                    console.log('üîí Perfil privado - n√£o buscando followers e following');
                    // Ocultar se√ß√µes de followers e following
                    const followersSection = document.getElementById('followersSection');
                    const followingSection = document.getElementById('followingSection');
                    if (followersSection) followersSection.style.display = 'none';
                    if (followingSection) followingSection.style.display = 'none';
                }
                
                // Promise 3: Buscar posts (INICIA IMEDIATAMENTE, N√ÉO ESPERA followers/following)
                const postsPromise = (async () => {
                    console.time('‚è±Ô∏è 4. Busca de posts (at√© 25 perfis)');
                    const start = performance.now();
                    
                    // Se precisar de followingData para posts, esperar
                    let localFollowersData = followersData;
                    let localFollowingData = followingData;
                    
                    if (!isPrivate && !localFollowingData) {
                        // Esperar followers/following se ainda n√£o chegaram
                        const result = await parallelPromises[0];
                        localFollowersData = result.followersData;
                        localFollowingData = result.followingData;
                    }
                    
                    await renderLastPostsProfiles(localFollowersData, localFollowingData, userData, isPrivate);
                    
                    const end = performance.now();
                    console.timeEnd('‚è±Ô∏è 4. Busca de posts (at√© 25 perfis)');
                    console.log(`   ‚îî‚îÄ Tempo: ${(end - start).toFixed(0)}ms`);
                })();
                
                parallelPromises.push(postsPromise);
                
                // Esperar TODAS as promises terminarem
                console.log(`üöÄ Aguardando ${parallelPromises.length} opera√ß√µes em paralelo...`);
                await Promise.all(parallelPromises);
                
                const parallelEnd = performance.now();
                console.log(`‚úÖ Paraleliza√ß√£o completa em ${(parallelEnd - parallelStart).toFixed(0)}ms`);
                
                // Salvar username no sessionStorage para manter ap√≥s F5
                sessionStorage.setItem('debug_last_username', username);
                
                document.getElementById('results').style.display = 'grid';
                showStatus('Dados carregados com sucesso!', 'success');
                
                const searchEndTime = performance.now();
                const totalTime = searchEndTime - searchStartTime;
                console.timeEnd('‚è±Ô∏è TEMPO TOTAL DA BUSCA');
                console.log(`\nüèÅ RESUMO DE PERFORMANCE:`);
                console.log(`   ‚îî‚îÄ Tempo total: ${totalTime.toFixed(0)}ms (${(totalTime / 1000).toFixed(2)}s)`);
                
            } catch (error) {
                console.error('Erro:', error);
                console.error('Stack:', error.stack);
                showStatus(`Erro ao buscar dados: ${error.message}. Verifique se o servidor est√° rodando na porta 8002.`, 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // Permitir buscar com Enter (aguardar DOM estar pronto)
        function setupEnterKey() {
            const input = document.getElementById('usernameInput');
            if (input) {
                input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
            } else {
                // Tentar novamente se o input ainda n√£o existir
                setTimeout(setupEnterKey, 100);
            }
        }
        
        // Fun√ß√£o para restaurar √∫ltimo usu√°rio pesquisado e fazer busca autom√°tica
        function restoreLastSearch() {
            const lastUsername = sessionStorage.getItem('debug_last_username');
            const searchInput = document.getElementById('usernameInput');
            const searchBtn = document.getElementById('searchBtn');
            
            if (lastUsername && searchInput && searchBtn) {
                // Preencher o campo com o √∫ltimo username
                searchInput.value = lastUsername;
                
                // Fazer a busca automaticamente ap√≥s um pequeno delay para garantir que tudo est√° carregado
                setTimeout(() => {
                    console.log(`üîÑ Restaurando busca autom√°tica para: ${lastUsername}`);
                    searchBtn.click();
                }, 300);
            }
        }
        
        // Inicializar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupEnterKey();
                restoreLastSearch();
            });
        } else {
            setupEnterKey();
            restoreLastSearch();
        }
    </script>
</body>
</html>
