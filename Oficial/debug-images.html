<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Teste de Imagens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #EB1C8F;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .test-section h2 {
            color: #EB1C8F;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .test-item {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #222;
        }
        
        .test-item h3 {
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .test-item .url {
            color: #888;
            font-size: 11px;
            word-break: break-all;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .test-item .image-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .test-item img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.loading {
            background: #ffa500;
            color: #000;
        }
        
        .status.success {
            background: #00ff00;
            color: #000;
        }
        
        .status.error {
            background: #ff0000;
            color: #fff;
        }
        
        .info {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .summary {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #333;
        }
        
        .summary h2 {
            color: #EB1C8F;
            margin-bottom: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .search-box {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .search-box h2 {
            color: #EB1C8F;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-form input {
            flex: 1;
            padding: 12px 16px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        
        .search-form input:focus {
            border-color: #EB1C8F;
        }
        
        .search-form input::placeholder {
            color: #666;
        }
        
        .search-form button {
            padding: 12px 24px;
            background: #EB1C8F;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-form button:hover {
            background: #d0167a;
        }
        
        .search-form button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .user-info {
            margin-top: 15px;
            padding: 12px;
            background: #0a0a0a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .user-info.success {
            border-color: #00ff00;
        }
        
        .user-info.error {
            border-color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Teste de Carregamento de Imagens</h1>
        
        <div class="search-box">
            <h2>üì± Buscar Usu√°rio do Instagram</h2>
            <form class="search-form" id="searchForm" onsubmit="searchUser(event)">
                <input 
                    type="text" 
                    id="usernameInput" 
                    placeholder="Digite o username do Instagram (ex: andre.menegon)" 
                    required
                    autocomplete="off"
                >
                <button type="submit" id="searchButton">Buscar</button>
            </form>
            <div id="userInfo" class="user-info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>1. URL Direta do Instagram (sem proxy)</h2>
            <div class="test-item" id="test-direct">
                <h3>URL Direta <span class="status loading" id="status-direct">Carregando...</span></h3>
                <div class="url" id="url-direct"></div>
                <div class="image-container">
                    <img id="img-direct" alt="Teste direto" onload="updateStatus('direct', 'success')" onerror="updateStatus('direct', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>2. Proxy Atual (/proxy-image)</h2>
            <div class="test-item" id="test-proxy">
                <h3>Proxy Atual <span class="status loading" id="status-proxy">Carregando...</span></h3>
                <div class="url" id="url-proxy"></div>
                <div class="image-container">
                    <img id="img-proxy" alt="Teste proxy" onload="updateStatus('proxy', 'success')" onerror="updateStatus('proxy', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>3. Estilo Concorrente (/_next/image) ‚≠ê</h2>
            <div class="test-item" id="test-next">
                <h3>Next.js Style <span class="status loading" id="status-next">Carregando...</span></h3>
                <div class="url" id="url-next"></div>
                <div class="info">üí° Esta √© a rota que o concorrente usa (/_next/image)</div>
                <div class="image-container">
                    <img id="img-next" alt="Teste Next.js" onload="updateStatus('next', 'success')" onerror="updateStatus('next', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>4. Proxy via API (/api/proxy-image)</h2>
            <div class="test-item" id="test-api-proxy">
                <h3>API Proxy <span class="status loading" id="status-api-proxy">Carregando...</span></h3>
                <div class="url" id="url-api-proxy"></div>
                <div class="image-container">
                    <img id="img-api-proxy" alt="Teste API proxy" onload="updateStatus('api-proxy', 'success')" onerror="updateStatus('api-proxy', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>5. Com srcset (m√∫ltiplas resolu√ß√µes)</h2>
            <div class="test-item" id="test-srcset">
                <h3>Srcset <span class="status loading" id="status-srcset">Carregando...</span></h3>
                <div class="url" id="url-srcset"></div>
                <div class="image-container">
                    <img id="img-srcset" alt="Teste srcset" 
                         srcset="/proxy-image?url=INSTAGRAM_URL&w=96&q=75 1x, /proxy-image?url=INSTAGRAM_URL&w=256&q=75 2x"
                         onload="updateStatus('srcset', 'success')" 
                         onerror="updateStatus('srcset', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>6. Com par√¢metros de qualidade</h2>
            <div class="test-item" id="test-quality">
                <h3>Quality 75 <span class="status loading" id="status-quality">Carregando...</span></h3>
                <div class="url" id="url-quality"></div>
                <div class="image-container">
                    <img id="img-quality" alt="Teste quality" onload="updateStatus('quality', 'success')" onerror="updateStatus('quality', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>7. Via getApiUrl() (fun√ß√£o do c√≥digo)</h2>
            <div class="test-item" id="test-getapi">
                <h3>getApiUrl() <span class="status loading" id="status-getapi">Carregando...</span></h3>
                <div class="url" id="url-getapi"></div>
                <div class="image-container">
                    <img id="img-getapi" alt="Teste getApiUrl" onload="updateStatus('getapi', 'success')" onerror="updateStatus('getapi', 'error', this)">
                </div>
            </div>
        </div>
        
        <div class="summary" id="summary">
            <h2>üìä Resumo</h2>
            <div id="summary-content"></div>
        </div>
    </div>
    
    <script>
        // URL de teste padr√£o do Instagram (ser√° substitu√≠da quando buscar usu√°rio)
        let INSTAGRAM_URL = 'https://scontent-lga3-2.cdninstagram.com/v/t51.2885-19/469280503_618774417244536_6789387411220436489_n.jpg?stp=dst-jpg_e0_s150x150_tt6&efg=eyJ2ZW5jb2RlX3RhZyI6InByb2ZpbGVfcGljLmRqYW5nby4xMDgwLmMyIn0&_nc_ht=scontent-lga3-2.cdninstagram.com&_nc_cat=100&_nc_oc=Q6cZ2QHYxhLxq_NmWYgEHgt0OBvkslJ4XIN1WsbpbSSKT3pq8HsIaDdv3qIireMn7I7Zbaw&_nc_ohc=m6SeHjrgpigQ7kNvwFlWz-2&_nc_gid=TuumDka_g-VGdCd1m-0TWA&edm=AO4kU9EBAAAA&ccb=7-5&ig_cache_key=GPem_Bt4AValxTICAAmWTfjgvzhebkULAAAB1501500j-ccb7-5&oh=00_AfkxBb_k83mPIrAUUZikSkx3xhJ0uOiQAw4gT_NUl_-9sw&oe=693586F4&_nc_sid=164c1d';
        
        let encodedUrl = encodeURIComponent(INSTAGRAM_URL);
        const results = {};
        
        // Fun√ß√£o para buscar usu√°rio do Instagram
        async function searchUser(event) {
            event.preventDefault();
            
            const usernameInput = document.getElementById('usernameInput');
            const searchButton = document.getElementById('searchButton');
            const userInfo = document.getElementById('userInfo');
            const username = usernameInput.value.trim();
            
            if (!username) return;
            
            // Desabilitar bot√£o e mostrar loading
            searchButton.disabled = true;
            searchButton.innerHTML = 'Buscando... <span class="loading-spinner"></span>';
            userInfo.style.display = 'none';
            
            // Limpar resultados anteriores
            Object.keys(results).forEach(key => delete results[key]);
            updateSummary();
            
            try {
                // Buscar dados do usu√°rio via API PHP
                const apiUrl = getApiUrl(`?username=${encodeURIComponent(username)}`);
                console.log('üîç Buscando usu√°rio na URL:', apiUrl);
                const response = await fetch(apiUrl);
                
                console.log('üì° Resposta da API:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erro na resposta:', errorText);
                    throw new Error(`Erro ${response.status}: ${response.statusText}\n${errorText.substring(0, 200)}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos:', data);
                
                // Verificar erro na resposta PHP
                if (data.error) {
                    throw new Error(data.message || data.error);
                }
                
                // PHP retorna: data.requests.account_data.result.data
                const accountData = data.requests?.account_data?.result;
                
                if (!accountData || !accountData.success || !accountData.data) {
                    console.error('‚ùå Resposta inv√°lida. Estrutura dos dados:', JSON.stringify(data, null, 2).substring(0, 500));
                    throw new Error(accountData?.error || 'Resposta inv√°lida da API. Verifique o console para ver a estrutura dos dados retornados.');
                }
                
                const user = accountData.data;
                
                // PHP usa v1, ent√£o profile_pic_url funciona diretamente
                const profilePicUrl = user.profile_pic_url || user.profile_pic_url_hd || '';
                
                if (!profilePicUrl) {
                    console.error('‚ùå Foto de perfil n√£o encontrada. Estrutura do usu√°rio:', JSON.stringify(user, null, 2).substring(0, 500));
                    throw new Error('Foto de perfil n√£o encontrada. Verifique o console para ver a estrutura dos dados retornados.');
                }
                
                // Atualizar URL da imagem
                INSTAGRAM_URL = profilePicUrl;
                encodedUrl = encodeURIComponent(INSTAGRAM_URL);
                
                // Mostrar informa√ß√µes do usu√°rio
                userInfo.className = 'user-info success';
                userInfo.innerHTML = `
                    <strong>‚úÖ Usu√°rio encontrado:</strong><br>
                    <strong>Username:</strong> @${user.username || username}<br>
                    <strong>Nome:</strong> ${user.full_name || 'N/A'}<br>
                    <strong>Seguidores:</strong> ${user.follower_count || 'N/A'}<br>
                    <strong>URL da foto:</strong> <span style="font-size: 10px; word-break: break-all;">${INSTAGRAM_URL.substring(0, 100)}...</span>
                `;
                userInfo.style.display = 'block';
                
                // Reiniciar todos os testes com a nova URL
                resetAllTests();
                
            } catch (error) {
                console.error('Erro ao buscar usu√°rio:', error);
                userInfo.className = 'user-info error';
                userInfo.innerHTML = `<strong>‚ùå Erro:</strong> ${error.message}`;
                userInfo.style.display = 'block';
            } finally {
                // Reabilitar bot√£o
                searchButton.disabled = false;
                searchButton.textContent = 'Buscar';
            }
        }
        
        // Fun√ß√£o para reiniciar todos os testes
        function resetAllTests() {
            // Resetar todos os status
            const testIds = ['direct', 'proxy', 'next', 'api-proxy', 'srcset', 'quality', 'getapi'];
            testIds.forEach(testId => {
                const statusEl = document.getElementById(`status-${testId}`);
                if (statusEl) {
                    statusEl.className = 'status loading';
                    statusEl.textContent = 'Carregando...';
                }
                
                // Remover mensagens de erro anteriores
                const testItem = document.getElementById(`test-${testId}`);
                if (testItem) {
                    const errorMsg = testItem.querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                }
            });
            
            // Limpar resultados
            Object.keys(results).forEach(key => delete results[key]);
            updateSummary();
            
            // Recarregar todas as imagens
            loadAllImages();
        }
        
        // Fun√ß√£o para carregar todas as imagens
        function loadAllImages() {
            // 1. URL Direta
            const imgDirect = document.getElementById('img-direct');
            const urlDirect = INSTAGRAM_URL;
            document.getElementById('url-direct').textContent = urlDirect;
            imgDirect.src = urlDirect;
            
            // 2. Proxy Atual
            const imgProxy = document.getElementById('img-proxy');
            const urlProxy = `/proxy-image?url=${encodedUrl}`;
            document.getElementById('url-proxy').textContent = urlProxy;
            imgProxy.src = urlProxy;
            
            // 3. Next.js Style
            const imgNext = document.getElementById('img-next');
            const urlNext = `/_next/image?url=${encodedUrl}&w=256&q=75`;
            document.getElementById('url-next').textContent = urlNext;
            imgNext.src = urlNext;
            
            // 4. API Proxy (via getApiUrl - mesma rota que o c√≥digo usa)
            const imgApiProxy = document.getElementById('img-api-proxy');
            const urlApiProxy = getApiUrl('/proxy-image') + '?url=' + encodedUrl;
            document.getElementById('url-api-proxy').textContent = urlApiProxy;
            imgApiProxy.src = urlApiProxy;
            
            // 5. Srcset
            const imgSrcset = document.getElementById('img-srcset');
            const urlSrcset1 = `/proxy-image?url=${encodedUrl}&w=96&q=75`;
            const urlSrcset2 = `/proxy-image?url=${encodedUrl}&w=256&q=75`;
            document.getElementById('url-srcset').textContent = `1x: ${urlSrcset1}\n2x: ${urlSrcset2}`;
            imgSrcset.srcset = `${urlSrcset1} 1x, ${urlSrcset2} 2x`;
            imgSrcset.src = urlSrcset2;
            
            // 6. Quality
            const imgQuality = document.getElementById('img-quality');
            const urlQuality = `/proxy-image?url=${encodedUrl}&w=256&q=75`;
            document.getElementById('url-quality').textContent = urlQuality;
            imgQuality.src = urlQuality;
            
            // 7. getApiUrl()
            const imgGetApi = document.getElementById('img-getapi');
            const urlGetApi = getApiUrl('/proxy-image') + '?url=' + encodedUrl;
            document.getElementById('url-getapi').textContent = urlGetApi;
            imgGetApi.src = urlGetApi;
        }
        
        // Fun√ß√£o getApiUrl (usa servidor PHP)
        function getApiUrl(endpoint) {
            // URL do servidor PHP
            const PHP_BACKEND = 'https://appofficial.website/in-stalker';
            
            // Se for /proxy-image, manter l√≥gica local
            if (endpoint.startsWith('/proxy-image') || endpoint.startsWith('/_next/image')) {
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocalhost) {
                    const port = window.location.port || '8001';
                    const apiPort = port === '8001' ? '8002' : port;
                    return `http://localhost:${apiPort}${endpoint}`;
                } else {
                    const protocol = window.location.protocol;
                    const hostname = window.location.hostname;
                    return `${protocol}//${hostname}${endpoint}`;
                }
            }
            
            // Para todas as outras requisi√ß√µes, usar o servidor PHP
            if (endpoint.includes('?')) {
                return `${PHP_BACKEND}/api-instagram.php?${endpoint.split('?')[1]}&api=plagio`;
            }
            
            return `${PHP_BACKEND}/api-instagram.php`;
        }
        
        // Atualizar status
        function updateStatus(testId, status, imgElement) {
            const statusEl = document.getElementById(`status-${testId}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = status === 'success' ? '‚úÖ Sucesso' : '‚ùå Erro';
            
            results[testId] = {
                status: status,
                timestamp: new Date().toLocaleTimeString()
            };
            
            if (status === 'error' && imgElement) {
                // Remover mensagem de erro anterior se existir
                const testItem = document.getElementById(`test-${testId}`);
                const existingError = testItem.querySelector('.error-message');
                if (existingError) existingError.remove();
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                
                // Tentar obter mais informa√ß√µes do erro
                let errorText = `Erro ao carregar: ${imgElement.src.substring(0, 100)}...`;
                
                // Se a imagem falhou, pode ser 404, CORS, etc.
                if (imgElement.src.includes('in-stalker.site')) {
                    errorText += '\nüí° Dica: Verifique se o Apache est√° fazendo proxy de /proxy-image e /_next/image';
                }
                
                errorMsg.textContent = errorText;
                testItem.appendChild(errorMsg);
                
                console.error(`‚ùå Erro no teste ${testId}:`, imgElement.src);
            }
            
            updateSummary();
        }
        
        // Atualizar resumo
        function updateSummary() {
            const summaryContent = document.getElementById('summary-content');
            summaryContent.innerHTML = '';
            
            const tests = [
                { id: 'direct', name: 'URL Direta' },
                { id: 'proxy', name: 'Proxy Atual' },
                { id: 'next', name: 'Next.js Style' },
                { id: 'api-proxy', name: 'API Proxy' },
                { id: 'srcset', name: 'Srcset' },
                { id: 'quality', name: 'Quality' },
                { id: 'getapi', name: 'getApiUrl()' }
            ];
            
            tests.forEach(test => {
                const result = results[test.id];
                if (result) {
                    const div = document.createElement('div');
                    div.className = 'summary-item';
                    div.innerHTML = `
                        <span>${test.name}</span>
                        <span style="color: ${result.status === 'success' ? '#00ff00' : '#ff0000'}">
                            ${result.status === 'success' ? '‚úÖ' : '‚ùå'} ${result.status.toUpperCase()}
                        </span>
                    `;
                    summaryContent.appendChild(div);
                }
            });
        }
        
        // Inicializar testes
        window.addEventListener('DOMContentLoaded', function() {
            loadAllImages();
        });
    </script>
</body>
</html>

